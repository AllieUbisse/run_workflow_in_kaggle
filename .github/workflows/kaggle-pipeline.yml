name: Push and Run Kaggle Notebook

on:
  push:
    branches: [ main ]

jobs:
  kaggle-pipeline:
    runs-on: ubuntu-latest

    env:
      STAGES: data_preprocesing
      
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Dependencies [Kaggle CLI] [jq]  
      run: |
        pip install kaggle jq

    - name: Configure Kaggle Credentials
      run: |
        mkdir -p ~/.kaggle
        echo "{\"username\":\"${{ secrets.KAGGLE_USERNAME }}\",\"key\":\"${{ secrets.KAGGLE_KEY }}\"}" > ~/.kaggle/kaggle.json
        chmod 600 ~/.kaggle/kaggle.json

    - name: Upload Dataset
      run: |
        kaggle datasets create -p ./data
        
    - name: Generate Unique Run ID
      id: generate_id
      run: |
        TIMESTAMP=$(date +%Y%m%d%H%M%S)
        HASH=$(echo "$TIMESTAMP" | md5sum | cut -c1-6)
        echo "run_id=${TIMESTAMP}-${HASH}" >> $GITHUB_OUTPUT
        
    - name: Push & Trigger Notebook on remote server [kaggle]
      run: |
        for STAGE in $STAGES; do
          echo "ðŸ”§ Processing stage: $STAGE"
          cd workflows/$STAGE
          echo "ðŸ“Œ Current Working Dir: $PWD"
          
          # Generate dynamic kernel [RUN ID]
          KERNEL_ID="${{ secrets.KAGGLE_USERNAME }}/${STAGE}-pipeline-${{ steps.generate_id.outputs.run_id }}"
          TITTLE_ID="${STAGE}-pipeline-${{ steps.generate_id.outputs.run_id }}"
          ENABLE_TPU="false"
          echo "ðŸ“Œ Kernel ID: $KERNEL_ID, TITTLE_ID: $TITTLE_ID"

          # Inject dynamic ID into metadata
          jq --arg id "$KERNEL_ID" '.id = $id' kernel-metadata.json > tmp && mv tmp kernel-metadata.json
          jq --arg title "$TITTLE_ID" '.title = $title' kernel-metadata.json > tmp && mv tmp kernel-metadata.json
          jq --arg enable_tpu "$ENABLE_TPU" '.enable_tpu = $enable_tpu' kernel-metadata.json > tmp && mv tmp kernel-metadata.json
          
          # Push and run
          kaggle kernels push 
          kaggle kernels output "$KERNEL_ID"

          cd - > /dev/null
        done

